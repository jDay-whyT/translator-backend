<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Translator Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="/app.css">
</head>
<body>
  <div class="container">
    <h1>Translator</h1>
    <div id="status" class="status"></div>

    <label for="inputText">Text</label>
    <textarea id="inputText" placeholder="Enter text..."></textarea>

    <div class="buttons" id="primaryButtons">
      <button data-target="ru">RU</button>
      <button data-target="en">EN</button>
      <button data-toggle="es">ES</button>
      <button data-toggle="pt">PT</button>
    </div>

    <div class="buttons hidden" id="esButtons">
      <button data-target="es-es">ES-ES</button>
      <button data-target="es-latam">ES-LATAM</button>
    </div>

    <div class="buttons hidden" id="ptButtons">
      <button data-target="pt-pt">PT-PT</button>
      <button data-target="pt-br">PT-BR</button>
    </div>

    <label for="outputText">Output</label>
    <textarea id="outputText" readonly></textarea>

    <button id="copyButton">Copy</button>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.ready?.();
    tg?.expand?.();

    const statusEl = document.getElementById("status");
    const inputText = document.getElementById("inputText");
    const outputText = document.getElementById("outputText");
    const copyButton = document.getElementById("copyButton");
    const allButtons = document.querySelectorAll("button");
    const toggleButtons = document.querySelectorAll("[data-toggle]");
    const targetButtons = document.querySelectorAll("[data-target]");
    const esButtons = document.getElementById("esButtons");
    const ptButtons = document.getElementById("ptButtons");

    const getInitData = () => tg?.initData || "";

    const setAllButtonsDisabled = (disabled) => {
      allButtons.forEach((button) => {
        button.disabled = disabled;
      });
    };

    const hideSubButtons = () => {
      esButtons.classList.add("hidden");
      ptButtons.classList.add("hidden");
    };

    const ensureTelegram = () => {
      if (!tg || !getInitData()) {
        statusEl.textContent = "Открой в Telegram (Mini App)";
        setAllButtonsDisabled(true);
        return false;
      }
      return true;
    };

    const resetUiState = () => {
      if (ensureTelegram()) {
        statusEl.textContent = "";
        setAllButtonsDisabled(false);
      }
    };

    const translate = async (target) => {
      if (!ensureTelegram()) {
        return;
      }

      setAllButtonsDisabled(true);
      statusEl.textContent = "Loading...";
      outputText.value = "";

      try {
        const res = await fetch("/api/translate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-TG-INITDATA": getInitData()
          },
          body: JSON.stringify({
            text: inputText.value || "",
            target
          })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          statusEl.textContent = "Request failed: " + (data.error || res.statusText);
          return;
        }

        outputText.value = data.text || data.translation || "";
        outputText.scrollIntoView({ behavior: "smooth", block: "start" });
        tg?.HapticFeedback?.impactOccurred?.("light");
        statusEl.textContent = "";
      } catch (err) {
        statusEl.textContent = "Request failed: " + err;
      } finally {
        resetUiState();
      }
    };

    const copyOutput = async () => {
      const text = outputText.value || "";
      if (!text) {
        return;
      }
      if (navigator.clipboard?.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return;
        } catch (err) {
        }
      }
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.setAttribute("readonly", "");
      textarea.style.position = "absolute";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand("copy");
      document.body.removeChild(textarea);
    };

    toggleButtons.forEach((button) => {
      button.addEventListener("click", () => {
        if (!ensureTelegram()) {
          return;
        }
        const toggle = button.dataset.toggle;
        if (toggle === "es") {
          esButtons.classList.toggle("hidden");
          ptButtons.classList.add("hidden");
          return;
        }
        if (toggle === "pt") {
          ptButtons.classList.toggle("hidden");
          esButtons.classList.add("hidden");
        }
      });
    });

    targetButtons.forEach((button) => {
      button.addEventListener("click", () => {
        hideSubButtons();
        translate(button.dataset.target);
      });
    });

    copyButton.addEventListener("click", () => {
      copyOutput();
    });

    hideSubButtons();
    if (ensureTelegram()) {
      setAllButtonsDisabled(false);
    }
  </script>
</body>
</html>
